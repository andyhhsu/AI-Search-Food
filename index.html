<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ç¾é£Ÿæ¢éšªå®¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5; /* Indigo 600 */
            --primary-color-hover: #4338ca; /* Indigo 700 */
        }
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6; /* Gray 100 */
        }
        .loader {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        .small-loader {
            width: 24px;
            height: 24px;
            border-width: 3px;
        }
        @keyframes card-fade-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card-animation {
            animation: card-fade-in 0.5s ease-out forwards;
            opacity: 0;
        }
        /* Modal Styles */
        #selection-modal-overlay { transition: opacity 0.3s ease-in-out; }
        #selection-modal-content { transition: transform 0.3s ease-in-out; }
    </style>
</head>
<body class="text-gray-800 min-h-screen flex flex-col items-center p-4 sm:p-8">

    <div class="w-full max-w-5xl mx-auto">
        
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-500 to-indigo-600">
                ç¾é£Ÿæ¢éšªå®¶
            </h1>
            <p class="text-gray-500 mt-2">ç‚ºæ‚¨å³æ™‚æœå°‹é™„è¿‘çš„é«˜åˆ†å¥½è©•åº—å®¶ï¼</p>
        </header>

        <div id="search-form-container" class="bg-white p-6 rounded-2xl shadow-lg mb-12 transition-opacity duration-300">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">åœ°å€</label>
                    <button id="area-select-trigger" class="w-full bg-gray-100 border-gray-300 border rounded-lg py-3 px-4 text-gray-800 text-left flex justify-between items-center">
                        <span id="area-display-text">ğŸ“ ç›®å‰ä½ç½®é™„è¿‘ (æ­¥è¡Œ10åˆ†é˜)</span>
                        <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ç¾é£Ÿç¨®é¡</label>
                     <button id="cuisine-select-trigger" class="w-full bg-gray-100 border-gray-300 border rounded-lg py-3 px-4 text-gray-800 text-left flex justify-between items-center">
                        <span id="cuisine-display-text">æ‰€æœ‰ç¾é£Ÿ</span>
                        <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            </div>
            <div class="mt-6 flex items-center justify-center">
                <input id="open-now-checkbox" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                <label for="open-now-checkbox" class="ml-2 block text-sm text-gray-700 select-none">åƒ…é¡¯ç¤ºç›®å‰ç‡Ÿæ¥­ä¸­åº—å®¶</label>
            </div>
             <button id="search-button" class="mt-6 w-full text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all flex items-center justify-center" style="background-color: var(--primary-color);" disabled>
                <span id="button-text">ç­‰å¾…åœ°åœ–æœå‹™...</span>
                <div id="button-loader" class="loader hidden"></div>
            </button>
        </div>

        <main id="results-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8">
        </main>
        
        <div id="pagination-container" class="w-full flex justify-center mt-8"></div>
    </div>
    
    <div id="selection-modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden opacity-0">
        <div id="selection-modal-content" class="fixed bottom-0 left-0 right-0 bg-white rounded-t-2xl p-4 transform translate-y-full max-h-[80vh] flex flex-col">
            <div class="flex-shrink-0 flex justify-between items-center pb-2 border-b border-gray-200">
                <h2 id="modal-title" class="text-xl font-bold">é¸æ“‡</h2>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-700">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="modal-options-container" class="py-2 overflow-y-auto">
            </div>
            <div id="modal-input-container" class="hidden p-2 border-t border-gray-200">
                 <input type="text" id="modal-custom-input" class="w-full bg-gray-100 border-gray-300 border rounded-lg py-3 px-4 text-gray-800 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                 <button id="modal-confirm-btn" class="mt-2 w-full text-white font-bold py-3 px-4 rounded-lg shadow-lg" style="background-color: var(--primary-color);">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const searchButton = document.getElementById('search-button');
        const searchFormContainer = document.getElementById('search-form-container');
        const areaSelectTrigger = document.getElementById('area-select-trigger');
        const cuisineSelectTrigger = document.getElementById('cuisine-select-trigger');
        const areaDisplayText = document.getElementById('area-display-text');
        const cuisineDisplayText = document.getElementById('cuisine-display-text');
        const openNowCheckbox = document.getElementById('open-now-checkbox'); 
        const resultsContainer = document.getElementById('results-container');
        const buttonText = document.getElementById('button-text');
        const buttonLoader = document.getElementById('button-loader');
        const paginationContainer = document.getElementById('pagination-container');
        const modalOverlay = document.getElementById('selection-modal-overlay');
        const modalContent = document.getElementById('selection-modal-content');
        const modalTitle = document.getElementById('modal-title');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalOptionsContainer = document.getElementById('modal-options-container');
        const modalInputContainer = document.getElementById('modal-input-container');
        const modalCustomInput = document.getElementById('modal-custom-input');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');

        // Global state
        let placesService, directionsService, geocoder, map; 
        let allFetchedPlaces = [], displayedCount = 0;
        const RESULTS_PER_PAGE = 21; 
        let currentSelections = { area: 'current_location', cuisine: '' };
        let activeModal = null;

        // Init Google Maps Services
        function initMap() {
            map = new google.maps.Map(document.createElement('div'));
            placesService = new google.maps.places.PlacesService(map);
            directionsService = new google.maps.DirectionsService();
            geocoder = new google.maps.Geocoder();
            console.log('Google Maps Services å·²æº–å‚™å°±ç·’ï¼');
            enableSearchButton();
        }

        function enableSearchButton() {
            searchButton.disabled = false;
            searchButton.classList.remove('opacity-50', 'cursor-not-allowed');
            searchButton.style.backgroundColor = 'var(--primary-color)';
            searchButton.onmouseover = () => searchButton.style.backgroundColor = 'var(--primary-color-hover)';
            searchButton.onmouseout = () => searchButton.style.backgroundColor = 'var(--primary-color)';
            buttonText.textContent = 'é–‹å§‹æœå°‹';
        }

        window.setTimeout(() => {
            if (!placesService) {
                console.error("Google Maps Service failed to load.");
                buttonText.textContent = 'åœ°åœ–æœå‹™è¼‰å…¥å¤±æ•—';
                searchButton.disabled = true;
                searchButton.style.backgroundColor = '#ef4444'; 
                searchButton.classList.add('cursor-not-allowed');
            }
        }, 5000);
        
        // *** FIX: Added missing function ***
        function getUserLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†ä½ç½®åŠŸèƒ½ã€‚"));
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        });
                    },
                    () => {
                        reject(new Error("ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®ã€‚è«‹ç¢ºèªæ‚¨å·²æˆæ¬Šç€è¦½å™¨è®€å–ä½ç½®è³‡è¨Šã€‚"));
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            });
        }


        // Modal Logic
        function openModal(type, title, options, customOptionValue) {
            activeModal = type;
            modalTitle.textContent = title;
            modalOptionsContainer.innerHTML = '';
            modalInputContainer.classList.add('hidden');

            options.forEach(opt => {
                const optionEl = document.createElement('div');
                optionEl.className = 'p-4 text-lg cursor-pointer hover:bg-gray-100 rounded-lg';
                optionEl.textContent = opt.text;
                optionEl.dataset.value = opt.value;
                optionEl.addEventListener('click', () => {
                    if (opt.value === customOptionValue) {
                        modalOptionsContainer.classList.add('hidden');
                        modalInputContainer.classList.remove('hidden');
                        modalCustomInput.value = '';
                        modalCustomInput.placeholder = `ä¾‹å¦‚ï¼š${opt.text === 'âœï¸ è‡ªè¡Œè¼¸å…¥åœ°å€...' ? 'å°åŒ—å¸‚ä¿¡ç¾©å€ã€æ—¥æœ¬æ±äº¬' : 'æ‹‰éºµã€èˆ’èŠ™è•¾'}`;
                        modalCustomInput.focus();
                    } else {
                        updateSelection(type, opt.value, opt.text);
                        closeModal();
                    }
                });
                modalOptionsContainer.appendChild(optionEl);
            });
            
            modalOptionsContainer.classList.remove('hidden');
            modalOverlay.classList.remove('hidden');
            setTimeout(() => {
                modalOverlay.classList.remove('opacity-0');
                modalContent.classList.remove('translate-y-full');
            }, 10);
        }

        function closeModal() {
            modalOverlay.classList.add('opacity-0');
            modalContent.classList.add('translate-y-full');
            setTimeout(() => modalOverlay.classList.add('hidden'), 300);
        }

        function updateSelection(type, value, text) {
             if (type === 'area') {
                currentSelections.area = value;
                areaDisplayText.textContent = text;
            } else {
                currentSelections.cuisine = value;
                cuisineDisplayText.textContent = text;
            }
        }
        
        modalConfirmBtn.addEventListener('click', () => {
            const inputValue = modalCustomInput.value.trim();
            if (inputValue) {
                updateSelection(activeModal, inputValue, inputValue);
                closeModal();
            }
        });

        // Event Listeners
        searchButton.addEventListener('click', (event) => {
            event.preventDefault();
            searchRestaurants();
        });

        areaSelectTrigger.addEventListener('click', () => {
             const options = [
                { text: 'ğŸ“ ç›®å‰ä½ç½®é™„è¿‘ (æ­¥è¡Œ10åˆ†é˜)', value: 'current_location' },
                { text: 'âœï¸ è‡ªè¡Œè¼¸å…¥åœ°å€...', value: 'custom_area_input' },
                { text: 'å°åŒ—å¸‚ ä¿¡ç¾©å€', value: 'å°åŒ—å¸‚ä¿¡ç¾©å€' }, { text: 'å°åŒ—å¸‚ å¤§å®‰å€', value: 'å°åŒ—å¸‚å¤§å®‰å€' },
                { text: 'å°åŒ—å¸‚ ä¸­å±±å€', value: 'å°åŒ—å¸‚ä¸­å±±å€' }, { text: 'å°åŒ—å¸‚ æ¾å±±å€', value: 'å°åŒ—å¸‚æ¾å±±å€' },
                { text: 'å°åŒ—å¸‚ ä¸­æ­£å€', value: 'å°åŒ—å¸‚ä¸­æ­£å€' }, { text: 'å°åŒ—å¸‚ è¬è¯å€', value: 'å°åŒ—å¸‚è¬è¯å€' },
                { text: 'å°åŒ—å¸‚ å…§æ¹–å€', value: 'å°åŒ—å¸‚å…§æ¹–å€' }, { text: 'å°åŒ—å¸‚ å£«æ—å€', value: 'å°åŒ—å¸‚å£«æ—å€' },
                { text: 'å°åŒ—å¸‚ å¤§åŒå€', value: 'å°åŒ—å¸‚å¤§åŒå€' }, { text: 'å°åŒ—å¸‚ æ–‡å±±å€', value: 'å°åŒ—å¸‚æ–‡å±±å€' },
                { text: 'æ–°åŒ—å¸‚ æ¿æ©‹å€', value: 'æ–°åŒ—å¸‚æ¿æ©‹å€' }, { text: 'æ–°åŒ—å¸‚ ä¸­å’Œå€', value: 'æ–°åŒ—å¸‚ä¸­å’Œå€' },
                { text: 'æ–°åŒ—å¸‚ æ°¸å’Œå€', value: 'æ–°åŒ—å¸‚æ°¸å’Œå€' }, { text: 'æ–°åŒ—å¸‚ æ–°èŠå€', value: 'æ–°åŒ—å¸‚æ–°èŠå€' },
                { text: 'æ–°åŒ—å¸‚ æ–°åº—å€', value: 'æ–°åŒ—å¸‚æ–°åº—å€' }, { text: 'æ–°åŒ—å¸‚ ä¸‰é‡å€', value: 'æ–°åŒ—å¸‚ä¸‰é‡å€' }
            ];
            openModal('area', 'é¸æ“‡åœ°å€', options, 'custom_area_input');
        });

        cuisineSelectTrigger.addEventListener('click', () => {
            const options = [
                { text: 'æ‰€æœ‰ç¾é£Ÿ', value: '' }, { text: 'ç‰›è‚‰éºµ', value: 'ç‰›è‚‰éºµ' },
                { text: 'ç«é‹', value: 'ç«é‹' }, { text: 'æ—¥å¼æ–™ç†', value: 'æ—¥å¼æ–™ç†' },
                { text: 'éŸ“å¼æ–™ç†', value: 'éŸ“å¼æ–™ç†' }, { text: 'ç¾©å¤§åˆ©éºµ', value: 'ç¾©å¤§åˆ©éºµ' },
                { text: 'ç¾å¼æ¼¢å ¡', value: 'ç¾å¼æ¼¢å ¡' }, { text: 'æ³°å¼æ–™ç†', value: 'æ³°å¼æ–™ç†' },
                { text: 'å’–å•¡å»³', value: 'å’–å•¡å»³' }, { text: 'æ—©åˆé¤', value: 'æ—©åˆé¤' },
                { text: 'å°åƒ', value: 'å°åƒ' }, { text: 'ç”œé»', value: 'ç”œé»' },
                { text: 'éºµåŒ…åº—', value: 'éºµåŒ…åº—' }, { text: 'ç´ é£Ÿ', value: 'ç´ é£Ÿ' },
                { text: 'âœï¸ è‡ªè¡Œè¼¸å…¥...', value: 'custom_cuisine_input' }
            ];
            openModal('cuisine', 'é¸æ“‡ç¾é£Ÿç¨®é¡', options, 'custom_cuisine_input');
        });
        
        closeModalBtn.addEventListener('click', closeModal);
        modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeModal(); });


        // --- Main Search Logic ---
        async function searchRestaurants() {
            resultsContainer.innerHTML = ''; 
            paginationContainer.innerHTML = ''; 
            allFetchedPlaces = []; 
            displayedCount = 0;
            
            const onlyOpen = openNowCheckbox.checked;

            if (!placesService) { /* ... error handling ... */ return; }

            showLoading(true);
            resultsContainer.innerHTML = `<div class="col-span-full text-center text-gray-500">æ­£åœ¨åŠªåŠ›æœå°‹ä¸­ï¼Œè«‹ç¨å€™...</div>`; 
            
            try {
                const userLocation = await getUserLocation().catch(err => {
                    console.warn(err.message);
                    return null;
                });

                const allRawResults = await fetchAllResults(currentSelections.area, onlyOpen, userLocation);
                
                if (allRawResults.length === 0) { 
                    resultsContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„é¤å»³ã€‚</p>`;
                    showLoading(false);
                    return;
                }
                
                resultsContainer.innerHTML = `<div class="col-span-full text-center text-gray-500">å–å¾— ${allRawResults.length} ç­†çµæœ... æ­£åœ¨è™•ç†è©³ç´°è³‡è¨Š...</div>`;

                let processedPlaces = await Promise.all(
                    allRawResults.map(place => processPlace(place, onlyOpen, userLocation))
                );

                processedPlaces = processedPlaces.filter(p => p !== null);
                processedPlaces.sort((a, b) => (b.user_ratings_total || 0) - (a.user_ratings_total || 0) || (b.rating || 0) - (a.rating || 0));
                allFetchedPlaces = processedPlaces;
                
                displayResults();
                showLoading(false);
                
            } catch (error) { 
                resultsContainer.innerHTML = `<p class="text-red-500 col-span-full text-center">${error.message}</p>`;
                showLoading(false);
            }
        }
        
        function fetchAllResults(area, onlyOpen, userLocation) {
            return new Promise(async (resolve, reject) => {
                let request;
                if (area === 'current_location') {
                    if (!userLocation) {
                        reject(new Error("ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®ï¼Œè«‹å…ˆæˆæ¬Šã€‚"));
                        return;
                    }
                    request = { location: new google.maps.LatLng(userLocation.lat, userLocation.lng), rankBy: google.maps.places.RankBy.DISTANCE, keyword: getSearchQuery() };
                } else {
                    const geoResult = await geocodeAddress(area);
                    request = { location: geoResult.location, radius: 5000, keyword: `${area} ${getSearchQuery()}` };
                }
                
                if (onlyOpen) request.openNow = true;

                let allResults = [];
                let pageCount = 0;
                const maxPages = 5; 

                const callback = (results, status, pagination) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                        allResults = allResults.concat(results);
                        pageCount++;
                        if (pagination && pagination.hasNextPage && pageCount < maxPages) {
                             setTimeout(() => pagination.nextPage(), 1500); 
                        } else {
                            resolve(allResults);
                        }
                    } else if (status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS && allResults.length > 0) {
                        resolve(allResults); 
                    } else if (status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
                        resolve([]); 
                    } else {
                        if (status === google.maps.places.PlacesServiceStatus.OVER_QUERY_LIMIT && pageCount < maxPages) {
                             console.warn("OVER_QUERY_LIMIT, retrying...");
                             setTimeout(() => pagination.nextPage(), 2000);
                        } else {
                            reject(new Error(`API æœå°‹å¤±æ•—ï¼Œç‹€æ…‹ï¼š ${status}`));
                        }
                    }
                };
                placesService.nearbySearch(request, callback);
            });
        }
        
        function getSearchQuery() {
            return currentSelections.cuisine === "" ? "é¤å»³" : currentSelections.cuisine;
        }
        
        function displayResults() {
            const resultsToShow = allFetchedPlaces.slice(0, displayedCount + RESULTS_PER_PAGE);
            resultsContainer.innerHTML = ''; 

            if (resultsToShow.length === 0) {
                 resultsContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center">æ‰¾ä¸åˆ°ç¬¦åˆæ‰€æœ‰æ¢ä»¶çš„é¤å»³ã€‚</p>`;
                 return;
            }

            resultsToShow.forEach((data, index) => {
                const card = createRestaurantCard(data, index);
                resultsContainer.appendChild(card);
            });
            displayedCount = resultsToShow.length;

            paginationContainer.innerHTML = '';
            if (displayedCount < allFetchedPlaces.length) {
                const loadMoreButton = document.createElement('button');
                loadMoreButton.textContent = `è¼‰å…¥æ›´å¤šçµæœ (${displayedCount} / ${allFetchedPlaces.length})`;
                loadMoreButton.className = "text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all flex items-center justify-center gap-2";
                loadMoreButton.style.backgroundColor = 'var(--primary-color)';
                loadMoreButton.onmouseover = () => loadMoreButton.style.backgroundColor = 'var(--primary-color-hover)';
                loadMoreButton.onmouseout = () => loadMoreButton.style.backgroundColor = 'var(--primary-color)';
                loadMoreButton.addEventListener('click', displayResults);
                paginationContainer.appendChild(loadMoreButton);
            }
        }
        
        function geocodeAddress(address) {
            return new Promise((resolve, reject) => {
                geocoder.geocode({ 'address': address }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        resolve({ location: results[0].geometry.location });
                    } else {
                        reject(new Error(`ç„¡æ³•æ‰¾åˆ°æ‚¨è¼¸å…¥çš„åœ°å€ï¼šã€Œ${address}ã€ã€‚`));
                    }
                });
            });
        }

        async function processPlace(place, onlyOpen, userLocation) {
            try {
                if (!place.rating || place.rating < 4.0 || !place.photos || !place.place_id) {
                    return null;
                }

                const detailedPlace = await getPlaceDetails(place.place_id);
                if (onlyOpen && detailedPlace.opening_hours?.isOpen() !== true) return null;

                if(userLocation && currentSelections.area === 'current_location') {
                     const userLatLng = new google.maps.LatLng(userLocation.lat, userLocation.lng);
                     const distanceData = await getWalkingDistance(userLatLng, detailedPlace.geometry.location);
                     if (distanceData && distanceData.durationValue <= 600) {
                         detailedPlace.distanceData = distanceData;
                     } else {
                         return null; 
                     }
                }
                return detailedPlace; 
            } catch (error) {
                console.error(`è™•ç†åœ°é» ${place.name} æ™‚ç™¼ç”ŸéŒ¯èª¤:`, error);
                return null; 
            }
        }
        
        function getWalkingDistance(origin, destination) {
             return new Promise((resolve) => {
                const request = { origin, destination, travelMode: 'WALKING' };
                directionsService.route(request, (result, status) => {
                    if (status == 'OK' && result.routes[0].legs[0]) {
                        const leg = result.routes[0].legs[0];
                        resolve({ distanceText: leg.distance.text, durationText: leg.duration.text, durationValue: leg.duration.value });
                    } else { resolve(null); }
                });
            });
        }
        
        function getPlaceDetails(placeId) {
            return new Promise((resolve, reject) => {
                const request = {
                    placeId,
                    fields: ['name', 'rating', 'user_ratings_total', 'formatted_address', 'photos', 'place_id', 'opening_hours', 'url', 'price_level', 'types', 'formatted_phone_number', 'geometry']
                };
                placesService.getDetails(request, (place, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK && place) {
                        resolve(place);
                    } else { reject(new Error(`ç„¡æ³•ç²å–åœ°é»è©³ç´°è³‡è¨Š: ${status}`)); }
                });
            });
        }
        
        function createRestaurantCard(place, index) {
            const card = document.createElement('div');
            card.className = "bg-white rounded-2xl shadow-lg overflow-hidden flex flex-col card-animation";
            card.style.animationDelay = `${index * 50}ms`;

            const photoUrl = place.photos?.[0]?.getUrl({ maxWidth: 400, maxHeight: 300 }) ?? 'https://placehold.co/400x300/e2e8f0/94a3b8?text=æš«ç„¡åœ–ç‰‡';
            const ratingStars = 'â˜…'.repeat(Math.round(place.rating)) + 'â˜†'.repeat(5 - Math.round(place.rating));
            const mapsUrl = place.url || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name)}&query_place_id=${place.place_id}`;
            
            let statusTag = '';
            if (place.opening_hours?.isOpen() !== undefined) {
                const isOpen = place.opening_hours.isOpen();
                const statusClass = isOpen ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                statusTag = `<span class="text-xs font-medium px-2.5 py-1 rounded-full ${statusClass}">${isOpen ? 'ç‡Ÿæ¥­ä¸­' : 'ä¼‘æ¯ä¸­'}</span>`;
            }
            
            let priceTag = '';
            if (place.price_level !== undefined && place.price_level !== null) {
                let priceText = '';
                switch (place.price_level) {
                    case 1: priceText = 'å¹³åƒ¹'; break;
                    case 2: priceText = 'ä¸­ç­‰åƒ¹ä½'; break;
                    case 3: priceText = 'é«˜åƒ¹ä½'; break;
                    case 4: priceText = 'å¥¢è¯é¥—å®´'; break;
                }
                if (priceText) {
                    priceTag = `<span class="text-xs font-medium px-2.5 py-1 rounded-full bg-indigo-100 text-indigo-800">${priceText}</span>`;
                }
            }

            const primaryType = getPrimaryType(place.types);
            const typeTag = primaryType ? `<p class="text-sm font-semibold text-indigo-600">${primaryType}</p>` : '';

            let hoursInfo = '';
            if (place.opening_hours?.weekday_text?.length > 0) {
                 const googleDayIndex = (new Date().getDay() + 6) % 7; 
                 const todayHoursText = place.opening_hours.weekday_text[googleDayIndex];
                 hoursInfo = `
                 <div class="flex items-center text-gray-500">
                    <svg class="w-4 h-4 mr-2 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M16.2,16.2L11,13V7H12.5V12.2L17,14.9L16.2,16.2Z" /></svg>
                    <span>${todayHoursText}</span>
                 </div>
                 `;
            }

            let phoneInfo = '';
            if (place.formatted_phone_number) {
                phoneInfo = `
                <div class="flex items-center text-gray-500">
                    <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,15.18C15.69,14.9 16.08,14.82 16.43,14.93C17.55,15.3 18.75,15.5 20,15.5A1,1 0 0,1 21,16.5V20A1,1 0 0,1 20,21A17,17 0 0,1 3,4A1,1 0 0,1 4,3H7.5A1,1 0 0,1 8.5,4C8.5,5.25 8.7,6.45 9.07,7.57C9.18,7.92 9.1,8.31 8.82,8.59L6.62,10.79Z" /></svg>
                    <a href="tel:${place.formatted_phone_number}" class="hover:text-indigo-600 transition-colors">${place.formatted_phone_number}</a>
                </div>
                `;
            }
            
            let distanceInfo = '';
            if (place.distanceData) {
                const displayText = place.distanceData.durationText ? `${place.distanceData.distanceText}ãƒ»ç´„ ${place.distanceData.durationText}` : place.distanceData.distanceText;
                distanceInfo = `<div class="flex items-center text-gray-500">
                     <svg class="w-4 h-4 mr-2 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M14.5,4A1.5,1.5 0 0,0 13,5.5A1.5,1.5 0 0,0 14.5,7A1.5,1.5 0 0,0 16,5.5A1.5,1.5 0 0,0 14.5,4M11.5,9L9,14.5V22H11V16H12V13.5L14.5,12L15.6,12.5L11.5,9Z" />
                     </svg>
                    <span>${displayText}</span>
                </div>`;
            }

            card.innerHTML = `
                <div class="relative">
                    <a href="${mapsUrl}" target="_blank" rel="noopener noreferrer" class="block">
                        <img src="${photoUrl}" alt="${place.name}" class="w-full h-48 object-cover">
                    </a>
                    <div class="absolute top-3 right-3 flex flex-wrap gap-2 justify-end">
                       ${statusTag} ${priceTag}
                    </div>
                </div>
                <div class="p-5 flex flex-col flex-grow">
                    ${typeTag}
                    <h2 class="text-lg font-bold mt-1 mb-1 text-gray-900 leading-tight">${place.name}</h2>
                    <div class="flex items-center mb-4 text-sm">
                        <span class="text-yellow-500 mr-1.5">${ratingStars}</span>
                        <span class="text-gray-600 font-semibold">${place.rating}</span>
                        <span class="text-gray-400 ml-1">(${place.user_ratings_total || 0}å‰‡)</span>
                    </div>
                     <div class="text-sm space-y-2.5 mt-auto pt-4 border-t border-gray-100">
                         <div class="flex items-center text-gray-500">
                             <svg class="w-4 h-4 mr-2 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12,11.5A2.5,2.5 0 0,1 9.5,9A2.5,2.5 0 0,1 12,6.5A2.5,2.5 0 0,1 14.5,9A2.5,2.5 0 0,1 12,11.5M12,2A7,7 0 0,0 5,9C5,14.25 12,22 12,22C12,22 19,14.25 19,9A7,7 0 0,0 12,2Z" /></svg>
                             <span class="leading-tight">${place.formatted_address || 'æœªæä¾›åœ°å€'}</span>
                         </div>
                         ${hoursInfo}
                         ${phoneInfo}
                         ${distanceInfo}
                     </div>
                </div>
            `;
            return card;
        }

        const typeTranslations = {
            'cafe': 'å’–å•¡å»³', 'restaurant': 'é¤å»³', 'bar': 'é…’å§', 'meal_delivery': 'å¤–é€',
            'meal_takeaway': 'å¤–å¸¶', 'bakery': 'éºµåŒ…åº—', 'sushi_restaurant': 'å£½å¸åº—',
            'ramen_restaurant': 'æ‹‰éºµåº—', 'italian_restaurant': 'ç¾©å¼é¤å»³', 'american_restaurant': 'ç¾å¼é¤å»³',
            'chinese_restaurant': 'ä¸­å¼é¤å»³', 'japanese_restaurant': 'æ—¥å¼æ–™ç†', 'korean_restaurant': 'éŸ“å¼æ–™ç†',
            'thai_restaurant': 'æ³°å¼æ–™ç†', 'indian_restaurant': 'å°åº¦æ–™ç†', 'vietnamese_restaurant': 'è¶Šå—æ–™ç†',
            'french_restaurant': 'æ³•å¼é¤å»³', 'spanish_restaurant': 'è¥¿ç­ç‰™é¤å»³', 'mexican_restaurant': 'å¢¨è¥¿å“¥é¤å»³',
            'vegetarian_restaurant': 'ç´ é£Ÿé¤å»³', 'fast_food_restaurant': 'é€Ÿé£Ÿåº—', 'seafood_restaurant': 'æµ·é®®é¤å»³',
            'steak_house': 'ç‰›æ’é¤¨', 'pizza_place': 'æŠ«è–©åº—', 'brunch_restaurant': 'æ—©åˆé¤'
        };

        function getPrimaryType(types) {
            if (!types) return '';
            for (const type of types) {
                if (typeTranslations[type]) {
                    return typeTranslations[type];
                }
            }
            return '';
        }

        function showLoading(isLoading) {
            searchFormContainer.classList.toggle('opacity-50', isLoading);
            searchFormContainer.classList.toggle('pointer-events-none', isLoading);
            buttonText.classList.toggle('hidden', isLoading);
            buttonLoader.classList.toggle('hidden', !isLoading);
            searchButton.disabled = isLoading;
        }

    </script>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB-Ev8iMdRHstXwwFL2L6JpghYzgGsbiqY&libraries=places,geometry&callback=initMap&language=zh-TW" async defer></script>
</body>
</html>
