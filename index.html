<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¾é£Ÿæ¢éšªå®¶</title>
    <!-- PWA Manifest -->
    <link id="manifest-link" rel="manifest">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ç¾é£Ÿæ¢éšªå®¶">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/4f46e5/ffffff?text=é£Ÿ">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --bg-color: #f8fafc;
        }
        body {
            font-family: 'Poppins', 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 40px;
        }
        /* å¡ç‰‡å‹•ç•« */
        @keyframes slide-up-fade {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card-enter {
            animation: slide-up-fade 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
        }
        /* äº¤é€šæ¨¡å¼æŒ‰éˆ•æ¨£å¼ */
        .mode-btn {
            transition: all 0.2s ease;
            border: 1px solid #e2e8f0;
            background-color: white;
            color: #64748b;
        }
        .mode-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.3);
        }
        /* åº•éƒ¨é¢æ¿å‹•ç•« */
        .bottom-sheet {
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            transform: translateY(100%);
        }
        .bottom-sheet.open {
            transform: translateY(0);
        }
        .bottom-sheet-overlay {
            transition: opacity 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }
        .bottom-sheet-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- 1. é ‚éƒ¨å°èˆªèˆ‡æœå°‹è§¸ç™¼ -->
    <div class="sticky top-0 z-30 bg-white/95 backdrop-blur-md border-b border-slate-200 px-4 py-3 shadow-sm">
        <div class="flex items-center justify-between gap-4 max-w-5xl mx-auto mb-3">
            <h1 class="text-xl font-bold text-indigo-600 flex-shrink-0">ç¾é£Ÿæ¢éšª</h1>
            <!-- æœå°‹è§¸ç™¼æ¢ -->
            <div id="search-trigger" class="flex-grow bg-slate-100 rounded-full px-4 py-2.5 flex items-center gap-2 text-sm text-slate-500 cursor-pointer hover:bg-slate-200 transition-colors">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>
                <span id="search-bar-text" class="truncate">é»æ­¤è¨­å®šæœå°‹æ¢ä»¶...</span>
            </div>
        </div>

        <!-- äº¤é€šæ–¹å¼é¸æ“‡ (Transport Mode) -->
        <div class="flex justify-center gap-3 max-w-5xl mx-auto mb-3">
            <button class="mode-btn active px-4 py-1.5 rounded-full text-sm font-bold flex items-center gap-1" onclick="setTransportMode('walking')">
                <span>ğŸš¶</span> æ­¥è¡Œ (10åˆ†)
            </button>
            <button class="mode-btn px-4 py-1.5 rounded-full text-sm font-bold flex items-center gap-1" onclick="setTransportMode('driving')">
                <span>ğŸš—</span> é–‹è»Š (5å…¬é‡Œ)
            </button>
        </div>
        
        <!-- å¿«ç¯©æŒ‰éˆ•ç¾¤çµ„ (Quick Filters) - è‡ªå‹•æ›è¡Œ -->
        <div class="flex flex-wrap gap-2 max-w-5xl mx-auto w-full justify-center sm:justify-start">
            <button onclick="quickSearch('')" class="whitespace-nowrap px-3 py-1.5 bg-indigo-50 border border-indigo-100 rounded-full text-xs font-bold text-indigo-600 shadow-sm active:scale-95 transition-transform">
                ğŸ½ï¸ æ‰€æœ‰ç¾é£Ÿ
            </button>
            <button onclick="quickSearch('ç‰›è‚‰éºµ')" class="whitespace-nowrap px-3 py-1.5 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-600 shadow-sm active:bg-indigo-50 active:text-indigo-600">ğŸœ ç‰›è‚‰éºµ</button>
            <button onclick="quickSearch('ç«é‹')" class="whitespace-nowrap px-3 py-1.5 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-600 shadow-sm active:bg-indigo-50 active:text-indigo-600">ğŸ² ç«é‹</button>
            <button onclick="quickSearch('æ—¥å¼æ–™ç†')" class="whitespace-nowrap px-3 py-1.5 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-600 shadow-sm active:bg-indigo-50 active:text-indigo-600">ğŸ£ æ—¥å¼æ–™ç†</button>
            <button onclick="quickSearch('éŸ“å¼æ–™ç†')" class="whitespace-nowrap px-3 py-1.5 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-600 shadow-sm active:bg-indigo-50 active:text-indigo-600">ğŸ¥˜ éŸ“å¼æ–™ç†</button>
            <button onclick="quickSearch('ç¾©å¤§åˆ©éºµ')" class="whitespace-nowrap px-3 py-1.5 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-600 shadow-sm active:bg-indigo-50 active:text-indigo-600">ğŸ ç¾©å¤§åˆ©éºµ</button>
            <button onclick="quickSearch('ç¾å¼æ¼¢å ¡')" class="whitespace-nowrap px-3 py-1.5 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-600 shadow-sm active:bg-indigo-50 active:text-indigo-600">ğŸ” ç¾å¼æ¼¢å ¡</button>
            <button onclick="quickSearch('æ³°å¼æ–™ç†')" class="whitespace-nowrap px-3 py-1.5 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-600 shadow-sm active:bg-indigo-50 active:text-indigo-600">ğŸŒ¶ï¸ æ³°å¼æ–™ç†</button>
            <button onclick="quickSearch('å’–å•¡å»³')" class="whitespace-nowrap px-3 py-1.5 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-600 shadow-sm active:bg-indigo-50 active:text-indigo-600">â˜• å’–å•¡å»³</button>
            <button onclick="quickSearch('æ—©åˆé¤')" class="whitespace-nowrap px-3 py-1.5 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-600 shadow-sm active:bg-indigo-50 active:text-indigo-600">ğŸ¥ æ—©åˆé¤</button>
            <button onclick="quickSearch('å°åƒ')" class="whitespace-nowrap px-3 py-1.5 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-600 shadow-sm active:bg-indigo-50 active:text-indigo-600">ğŸ¥Ÿ å°åƒ</button>
            <button onclick="quickSearch('ç”œé»')" class="whitespace-nowrap px-3 py-1.5 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-600 shadow-sm active:bg-indigo-50 active:text-indigo-600">ğŸ° ç”œé»</button>
            <button onclick="quickSearch('éºµåŒ…åº—')" class="whitespace-nowrap px-3 py-1.5 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-600 shadow-sm active:bg-indigo-50 active:text-indigo-600">ğŸ éºµåŒ…åº—</button>
            <button onclick="quickSearch('ç´ é£Ÿ')" class="whitespace-nowrap px-3 py-1.5 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-600 shadow-sm active:bg-indigo-50 active:text-indigo-600">ğŸ¥— ç´ é£Ÿ</button>
        </div>
    </div>

    <!-- 2. ä¸»è¦å…§å®¹å€ -->
    <div class="w-full max-w-5xl mx-auto px-4 pt-4">
        
        <!-- éŒ¯èª¤è¨Šæ¯å®¹å™¨ -->
        <div id="error-container" class="hidden mb-6 bg-red-50 border border-red-100 text-red-600 px-4 py-3 rounded-xl text-sm text-center"></div>

        <!-- åˆ—è¡¨æ¨¡å¼å®¹å™¨ -->
        <div id="list-view-container">
            <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- åˆå§‹ç‹€æ…‹ -->
                <div class="col-span-full text-center py-20 opacity-40">
                    <div class="inline-block p-6 rounded-full bg-slate-200 mb-4">
                        <svg class="w-10 h-10 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>
                    </div>
                    <p class="text-slate-500 font-medium">è«‹é¸æ“‡äº¤é€šæ–¹å¼èˆ‡ç¾é£Ÿç¨®é¡</p>
                </div>
            </div>
            <!-- è¼‰å…¥æ›´å¤šæŒ‰éˆ• -->
            <div id="pagination-container" class="w-full flex justify-center mt-8 mb-8"></div>
        </div>
    </div>

    <!-- 3. æµ®å‹•åŠŸèƒ½æŒ‰éˆ• (FAB) - åƒ…ä¿ç•™å›åˆ°é ‚éƒ¨ -->
    <div class="fixed bottom-6 right-6 z-40 flex flex-col gap-3">
        <button id="back-to-top-btn" class="hidden bg-white/90 backdrop-blur text-slate-600 p-3 rounded-full shadow-lg border border-slate-100 hover:bg-slate-50 transition-all">
            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg>
        </button>
    </div>

    <!-- 4. æœå°‹è¨­å®š Bottom Sheet -->
    <div id="bottom-sheet-overlay" class="bottom-sheet-overlay fixed inset-0 bg-black/60 z-50 backdrop-blur-sm"></div>
    <div id="bottom-sheet" class="bottom-sheet fixed bottom-0 left-0 right-0 bg-white z-50 rounded-t-[2rem] shadow-2xl max-h-[85vh] flex flex-col">
        <div class="w-full flex justify-center pt-3 pb-1 flex-shrink-0" onclick="closeBottomSheet()">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full"></div>
        </div>
        
        <div class="p-6 pt-2 flex flex-col h-full overflow-hidden">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 id="sheet-title" class="text-xl font-bold text-slate-800">æœå°‹è¨­å®š</h2>
                <button onclick="closeBottomSheet()" class="p-2 bg-slate-100 rounded-full text-slate-500">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>

            <div id="sheet-main-view" class="flex flex-col gap-4 overflow-y-auto pb-4">
                <button onclick="showOptions('area')" class="w-full text-left flex-shrink-0">
                    <span class="text-xs font-bold text-slate-400 ml-1 block mb-1">åœ°å€</span>
                    <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4 flex justify-between items-center active:bg-slate-100 transition-colors">
                        <span id="selected-area-text" class="font-medium text-slate-800">ğŸ“ ç›®å‰ä½ç½®é™„è¿‘</span>
                        <svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                    </div>
                </button>

                <button id="main-search-btn" class="mt-4 w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-indigo-200 active:scale-95 transition-transform flex-shrink-0">
                    é–‹å§‹æœå°‹
                </button>
                <div class="h-8"></div>
            </div>

            <div id="sheet-options-view" class="hidden flex-col h-full overflow-hidden">
                <div class="mb-2 flex-shrink-0">
                    <button onclick="showMainView()" class="text-sm text-slate-500 flex items-center gap-1 mb-2 py-2">
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>
                        è¿”å›è¨­å®š
                    </button>
                </div>
                <div id="options-list" class="flex-grow overflow-y-auto space-y-2 pr-2 pb-6"></div>
                
                <div id="custom-input-area" class="hidden pt-4 mt-2 border-t border-slate-100 flex-shrink-0">
                    <div class="flex gap-2">
                        <input type="text" id="custom-input" class="flex-grow bg-slate-50 border border-slate-300 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="è«‹è¼¸å…¥...">
                        <button id="custom-input-confirm" class="bg-slate-900 text-white px-6 rounded-xl font-bold">ç¢ºèª</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const searchTrigger = document.getElementById('search-trigger');
        const searchBarText = document.getElementById('search-bar-text');
        const resultsContainer = document.getElementById('results-container');
        const paginationContainer = document.getElementById('pagination-container');
        const errorContainer = document.getElementById('error-container');
        const backToTopBtn = document.getElementById('back-to-top-btn');
        
        // Bottom Sheet Elements
        const bottomSheet = document.getElementById('bottom-sheet');
        const bottomSheetOverlay = document.getElementById('bottom-sheet-overlay');
        const sheetTitle = document.getElementById('sheet-title');
        const sheetMainView = document.getElementById('sheet-main-view');
        const sheetOptionsView = document.getElementById('sheet-options-view');
        const optionsList = document.getElementById('options-list');
        const customInputArea = document.getElementById('custom-input-area');
        const customInput = document.getElementById('custom-input');
        const customInputConfirm = document.getElementById('custom-input-confirm');
        
        const selectedAreaText = document.getElementById('selected-area-text');
        const mainSearchBtn = document.getElementById('main-search-btn');

        // Global state
        let placesService, directionsService, geocoder; 
        let allBasicPlaces = []; 
        let displayedCount = 0;
        const BATCH_SIZE = 20; 
        // é è¨­ç‹€æ…‹
        let currentSelections = { 
            area: 'current_location', 
            areaName: 'ğŸ“ ç›®å‰ä½ç½®é™„è¿‘', 
            cuisine: '', 
            cuisineName: 'æ‰€æœ‰ç¾é£Ÿ',
            mode: 'walking' // é è¨­æ­¥è¡Œ
        };
        let currentUserLocation = null;
        let activeSelectionType = null; 

        // PWA Setup
        const manifest = {
            "name": "ç¾é£Ÿæ¢éšªå®¶",
            "short_name": "ç¾é£Ÿæ¢éšª",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#f3f4f6",
            "theme_color": "#4f46e5",
            "description": "å³æ™‚æœå°‹é™„è¿‘çš„é«˜åˆ†å¥½è©•åº—å®¶ï¼",
            "icons": [{"src": "https://placehold.co/192x192/4f46e5/ffffff?text=é£Ÿ","sizes": "192x192","type": "image/png"}, {"src": "https://placehold.co/512x512/4f46e5/ffffff?text=é£Ÿ","sizes": "512x512","type": "image/png"}]
        };
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        document.getElementById('manifest-link').href = URL.createObjectURL(manifestBlob);

        // Init Google Maps Services
        function initMap() {
            const mapDiv = document.createElement('div');
            const map = new google.maps.Map(mapDiv, { center: { lat: 25.033964, lng: 121.564468 }, zoom: 14 });
            placesService = new google.maps.places.PlacesService(map);
            directionsService = new google.maps.DirectionsService();
            geocoder = new google.maps.Geocoder();
            console.log('Map Services Ready');
            getUserLocation(true).catch(() => {}); 
        }

        // Location
        function getUserLocation(silent = false) {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    if (!silent) showError("æ‚¨çš„è£ç½®ä¸æ”¯æ´å®šä½åŠŸèƒ½");
                    reject(new Error("ä¸æ”¯æ´å®šä½"));
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentUserLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                        resolve(currentUserLocation);
                    },
                    (error) => {
                        currentUserLocation = null;
                        if (!silent && error.code === error.PERMISSION_DENIED) {
                            showError("ç„¡æ³•å–å¾—ä½ç½®ï¼šæ‚¨æ‹’çµ•äº†æˆæ¬Šã€‚è«‹æ”¹ç”¨ã€Œæ‰‹å‹•é¸æ“‡åœ°å€ã€æœå°‹ã€‚");
                        }
                        reject(error);
                    },
                    { enableHighAccuracy: true, timeout: 5000 }
                );
            });
        }

        function showError(msg) {
            errorContainer.textContent = msg;
            errorContainer.classList.remove('hidden');
            setTimeout(() => errorContainer.classList.add('hidden'), 5000);
        }

        // --- Transport Mode Logic ---
        window.setTransportMode = (mode) => {
            currentSelections.mode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes(mode === 'walking' ? 'æ­¥è¡Œ' : 'é–‹è»Š')) {
                    btn.classList.add('active');
                }
            });
            // å¦‚æœå·²ç¶“æœ‰é¸æ“‡ç¾é£Ÿï¼Œç›´æ¥é‡æ–°æœå°‹
            if (allBasicPlaces.length > 0 || currentSelections.cuisine !== '') {
                performSearch();
            }
        };

        // --- Bottom Sheet UI Logic ---
        function openBottomSheet() {
            bottomSheetOverlay.classList.add('open');
            bottomSheet.classList.add('open');
            showMainView();
        }

        function closeBottomSheet() {
            bottomSheet.classList.remove('open');
            bottomSheetOverlay.classList.remove('open');
        }

        function showMainView() {
            sheetTitle.textContent = 'æœå°‹è¨­å®š';
            sheetMainView.classList.remove('hidden');
            sheetOptionsView.classList.add('hidden');
        }

        function showOptions(type) {
            if (type !== 'area') return; // ç¾åœ¨åªæœ‰åœ°å€éœ€è¦ Modalï¼Œç¾é£Ÿå·²åœ¨é¦–é 
            
            activeSelectionType = type;
            sheetTitle.textContent = 'é¸æ“‡åœ°å€';
            sheetMainView.classList.add('hidden');
            sheetOptionsView.classList.remove('hidden');
            optionsList.innerHTML = '';
            customInputArea.classList.add('hidden');

            const options = [
                { text: 'ğŸ“ ç›®å‰ä½ç½®é™„è¿‘', value: 'current_location' },
                { text: 'âœï¸ è‡ªè¡Œè¼¸å…¥åœ°å€...', value: 'custom' },
                { text: 'å°åŒ—å¸‚ ä¿¡ç¾©å€', value: 'å°åŒ—å¸‚ä¿¡ç¾©å€' }, { text: 'å°åŒ—å¸‚ å¤§å®‰å€', value: 'å°åŒ—å¸‚å¤§å®‰å€' },
                { text: 'å°åŒ—å¸‚ ä¸­å±±å€', value: 'å°åŒ—å¸‚ä¸­å±±å€' }, { text: 'å°åŒ—å¸‚ æ¾å±±å€', value: 'å°åŒ—å¸‚æ¾å±±å€' },
                { text: 'å°åŒ—å¸‚ ä¸­æ­£å€', value: 'å°åŒ—å¸‚ä¸­æ­£å€' }, { text: 'å°åŒ—å¸‚ è¬è¯å€', value: 'å°åŒ—å¸‚è¬è¯å€' },
                { text: 'å°åŒ—å¸‚ å…§æ¹–å€', value: 'å°åŒ—å¸‚å…§æ¹–å€' }, { text: 'å°åŒ—å¸‚ å£«æ—å€', value: 'å°åŒ—å¸‚å£«æ—å€' },
                { text: 'å°åŒ—å¸‚ å¤§åŒå€', value: 'å°åŒ—å¸‚å¤§åŒå€' }, { text: 'å°åŒ—å¸‚ æ–‡å±±å€', value: 'å°åŒ—å¸‚æ–‡å±±å€' },
                { text: 'æ–°åŒ—å¸‚ æ¿æ©‹å€', value: 'æ–°åŒ—å¸‚æ¿æ©‹å€' }, { text: 'æ–°åŒ—å¸‚ ä¸­å’Œå€', value: 'æ–°åŒ—å¸‚ä¸­å’Œå€' },
                { text: 'æ–°åŒ—å¸‚ æ°¸å’Œå€', value: 'æ–°åŒ—å¸‚æ°¸å’Œå€' }, { text: 'æ–°åŒ—å¸‚ æ–°èŠå€', value: 'æ–°åŒ—å¸‚æ–°èŠå€' },
                { text: 'æ–°åŒ—å¸‚ æ–°åº—å€', value: 'æ–°åŒ—å¸‚æ–°åº—å€' }, { text: 'æ–°åŒ—å¸‚ ä¸‰é‡å€', value: 'æ–°åŒ—å¸‚ä¸‰é‡å€' },
            ];

            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'w-full text-left py-4 px-4 bg-slate-50 rounded-xl font-medium text-slate-700 hover:bg-indigo-50 hover:text-indigo-600 transition-colors border-b border-slate-100 last:border-0';
                btn.textContent = opt.text;
                btn.onclick = () => {
                    if (opt.value === 'custom') {
                        customInputArea.classList.remove('hidden');
                        customInput.value = '';
                        customInput.placeholder = 'ä¾‹å¦‚ï¼šå°ä¸­è¥¿å€ã€æ±äº¬æ–°å®¿';
                        customInput.focus();
                        optionsList.scrollTop = optionsList.scrollHeight;
                    } else {
                        selectOption(opt.value, opt.text);
                        closeBottomSheet();
                        // è‹¥æœ‰ç¾é£Ÿé¸æ“‡ï¼Œå¯è€ƒæ…®è‡ªå‹•æœå°‹
                    }
                };
                optionsList.appendChild(btn);
            });
        }

        function selectOption(value, text) {
            if (activeSelectionType === 'area') {
                currentSelections.area = value;
                currentSelections.areaName = text;
                selectedAreaText.textContent = text;
            }
            showMainView();
        }

        customInputConfirm.onclick = () => {
            const val = customInput.value.trim();
            if (val) {
                selectOption(val, val);
                closeBottomSheet();
            }
        };

        searchTrigger.addEventListener('click', openBottomSheet);
        bottomSheetOverlay.addEventListener('click', closeBottomSheet);
        mainSearchBtn.addEventListener('click', () => {
            closeBottomSheet();
            performSearch();
        });

        window.quickSearch = (cuisine) => {
            currentSelections.cuisine = cuisine;
            currentSelections.cuisineName = cuisine || 'æ‰€æœ‰ç¾é£Ÿ';
            performSearch();
        }

        window.addEventListener('scroll', () => {
            if (window.scrollY > 300) backToTopBtn.classList.remove('hidden');
            else backToTopBtn.classList.add('hidden');
        });
        backToTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

        // --- æ ¸å¿ƒæœå°‹é‚è¼¯ (é‡æ§‹ç‰ˆ) ---
        async function performSearch(isInitial = true) {
            const modeText = currentSelections.mode === 'walking' ? '(æ­¥è¡Œ10åˆ†)' : '(é–‹è»Š5km)';
            searchBarText.textContent = `${currentSelections.areaName} çš„ ${currentSelections.cuisineName} ${modeText}`;
            
            if (isInitial) {
                resultsContainer.innerHTML = '';
                paginationContainer.innerHTML = '';
                allBasicPlaces = [];
                displayedCount = 0;
                
                resultsContainer.innerHTML = Array(6).fill(0).map(() => `
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 h-72 animate-pulse">
                        <div class="bg-slate-200 h-40 rounded-t-2xl"></div>
                        <div class="p-4 space-y-3">
                            <div class="h-5 bg-slate-200 rounded w-3/4"></div>
                            <div class="h-4 bg-slate-200 rounded w-1/2"></div>
                        </div>
                    </div>
                `).join('');
            }

            try {
                if (currentSelections.area === 'current_location' && !currentUserLocation) {
                    await getUserLocation();
                }

                if (isInitial) {
                    const basicResults = await fetchAllBasicPlaces(currentSelections.area, currentUserLocation);
                    if (basicResults.length === 0) {
                        resultsContainer.innerHTML = `<div class="col-span-full text-center py-10 text-slate-500">æ‰¾ä¸åˆ°ç›¸é—œé¤å»³ ğŸ¥²<br>è©¦è©¦çœ‹å…¶ä»–é—œéµå­—å§ï¼</div>`;
                        return;
                    }
                    // å…¨åŸŸæ’åº
                    allBasicPlaces = basicResults.sort((a, b) => (b.user_ratings_total || 0) - (a.user_ratings_total || 0));
                }

                await loadNextBatch();

            } catch (e) {
                if (resultsContainer.innerHTML.includes('animate-pulse')) resultsContainer.innerHTML = '';
                if (currentSelections.area === 'current_location' && !currentUserLocation) {
                     resultsContainer.innerHTML = `
                        <div class="col-span-full text-center p-6 bg-yellow-50 rounded-2xl border border-yellow-100">
                            <h3 class="font-bold text-yellow-800 mb-2">ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®</h3>
                            <p class="text-yellow-700 text-sm">è«‹æª¢æŸ¥ç€è¦½å™¨æ¬Šé™ï¼Œæˆ–æ”¹ç”¨ã€Œè‡ªè¡Œè¼¸å…¥åœ°å€ã€åŠŸèƒ½ã€‚</p>
                        </div>
                    `;
                } else {
                    showError(e.message);
                }
            }
        }

        function fetchAllBasicPlaces(area, loc) {
            return new Promise(async (resolve, reject) => {
                let request;
                const keyword = currentSelections.cuisine || 'é¤å»³';
                let minRating = 4.0;

                if (area === 'current_location') {
                    if (!loc) { reject(new Error("ç„¡å®šä½æ¬Šé™")); return; }
                    
                    try {
                         const geoResult = await reverseGeocode(loc);
                         const isJapan = geoResult.address_components.some(c => c.short_name === 'JP');
                         if (isJapan) minRating = 3.5;
                    } catch (e) { console.warn("Reverse geocoding failed", e); }
                    
                    // æ ¹æ“šæ¨¡å¼è¨­å®š Radius
                    // æ­¥è¡Œ: é æŠ“ 1.5km è®“å¾ŒçºŒéæ¿¾
                    // é–‹è»Š: 5km
                    const radius = currentSelections.mode === 'walking' ? 1500 : 5000;
                    
                    // é›–ç„¶ nearbySearch rankBy:DISTANCE ä¸æ”¯æ´ radius, ä½†è‹¥ç”¨ keyword æœå°‹é€šå¸¸æœƒçµ¦æ¯”è¼ƒé 
                    // è‹¥è¦åš´æ ¼è·é›¢ï¼Œå¯ç”¨ rankBy: PROMINENCE + radius
                    // é€™è£¡ç­–ç•¥ï¼šæ­¥è¡Œç”¨ DISTANCE (æœ€è¿‘å„ªå…ˆ)ï¼Œé–‹è»Šç”¨ PROMINENCE + Radius (ç†±é–€å„ªå…ˆ)
                    if (currentSelections.mode === 'walking') {
                         request = { location: new google.maps.LatLng(loc.lat, loc.lng), rankBy: google.maps.places.RankBy.DISTANCE, keyword: keyword };
                    } else {
                         request = { location: new google.maps.LatLng(loc.lat, loc.lng), radius: radius, keyword: keyword };
                    }

                } else {
                    try {
                        const geoData = await geocodeAddress(area);
                        if (geoData.isJapan) minRating = 3.5;
                        // æŒ‡å®šåœ°å€ä¸€å¾‹ç”¨ 5km (æˆ–æ›´å»£)
                        request = { location: geoData.location, radius: 5000, keyword: `${area} ${keyword}` };
                    } catch (e) { reject(e); return; }
                }

                let allResults = [];
                let pageCount = 0;
                const fetchPage = (nextPageToken) => { if (nextPageToken) request.pageToken = nextPageToken; };

                placesService.nearbySearch(request, (results, status, pagination) => {
                    if (status === 'OK') {
                        const validResults = results.filter(p => p.rating >= minRating && p.user_ratings_total > 10);
                        allResults = allResults.concat(validResults);
                        pageCount++;
                        
                        if (pagination && pagination.hasNextPage && pageCount < 3) {
                            setTimeout(() => pagination.nextPage(), 2000); 
                        } else {
                            resolve(allResults);
                        }
                    } else if (status === 'ZERO_RESULTS') {
                        resolve([]);
                    } else {
                        if (pageCount === 0) reject(new Error("API Error: " + status));
                        else resolve(allResults);
                    }
                });
            });
        }

        async function loadNextBatch() {
            if (displayedCount === 0) resultsContainer.innerHTML = '';
            
            const batch = allBasicPlaces.slice(displayedCount, displayedCount + BATCH_SIZE);
            if (batch.length === 0) return;

            const processedBatch = await Promise.all(batch.map(p => processPlaceDetails(p, currentUserLocation)));
            const validBatch = processedBatch.filter(p => p !== null);

            validBatch.forEach(place => {
                resultsContainer.appendChild(createCard(place));
            });

            displayedCount += BATCH_SIZE;
            updatePaginationButton();
        }

        function updatePaginationButton() {
            paginationContainer.innerHTML = '';
            // *** FIX: ä½¿ç”¨ correct variable 'allBasicPlaces' ***
            if (displayedCount < allBasicPlaces.length) {
                const btn = document.createElement('button');
                btn.innerHTML = `è¼‰å…¥æ›´å¤š <span class="text-xs opacity-70 ml-1">(${displayedCount}/${allBasicPlaces.length})</span>`;
                btn.className = "bg-white border border-slate-300 text-slate-600 px-8 py-3 rounded-full font-bold shadow-sm hover:bg-slate-50 hover:text-indigo-600 transition-all active:scale-95";
                btn.onclick = () => {
                    btn.innerHTML = `<div class="loader small-loader border-slate-400 border-t-indigo-600"></div>`;
                    loadNextBatch();
                };
                paginationContainer.appendChild(btn);
            }
        }

        // API Wrappers & Helpers
        function geocodeAddress(address) {
            return new Promise((resolve, reject) => {
                geocoder.geocode({ address }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const isJapan = results[0].address_components.some(c => c.short_name === 'JP');
                        resolve({ location: results[0].geometry.location, isJapan });
                    }
                    else reject(new Error("æ‰¾ä¸åˆ°è©²åœ°å€"));
                });
            });
        }
        
        function reverseGeocode(loc) {
             return new Promise((resolve, reject) => {
                geocoder.geocode({ location: loc }, (results, status) => {
                    if (status === 'OK' && results[0]) resolve(results[0]);
                    else reject(status);
                });
            });
        }

        function processPlaceDetails(place, loc) {
            return new Promise(resolve => {
                placesService.getDetails({
                    placeId: place.place_id,
                    fields: ['name', 'rating', 'user_ratings_total', 'formatted_address', 'photos', 'place_id', 'opening_hours', 'url', 'price_level', 'geometry', 'types', 'formatted_phone_number']
                }, async (detail, status) => {
                    if (status === 'OK') {
                        if (loc) {
                            const userLatLng = new google.maps.LatLng(loc.lat, loc.lng);
                            const distMeters = google.maps.geometry.spherical.computeDistanceBetween(userLatLng, detail.geometry.location);
                            
                            if (currentSelections.area === 'current_location') {
                                // æ­¥è¡Œæ¨¡å¼ï¼šåš´æ ¼ 10 åˆ†é˜ (ç´„ 800m)
                                if (currentSelections.mode === 'walking') {
                                    if (distMeters <= 1200) { // å…ˆç”¨ç›´ç·šåˆç¯©
                                        const route = await getWalkingRoute(userLatLng, detail.geometry.location);
                                        if (route && route.value <= 600) { // 600ç§’
                                            detail.distanceData = route;
                                            resolve(detail);
                                        } else resolve(null);
                                    } else resolve(null);
                                } 
                                // é–‹è»Šæ¨¡å¼ï¼š5å…¬é‡Œå…§
                                else {
                                    if (distMeters <= 5000) {
                                        const distText = distMeters > 1000 ? (distMeters/1000).toFixed(1) + ' km' : Math.round(distMeters) + ' m';
                                        detail.distanceData = { text: distText + ' (ç›´ç·š)' };
                                        resolve(detail);
                                    } else resolve(null);
                                }
                            } else {
                                // æŒ‡å®šåœ°å€ï¼šé¡¯ç¤ºç›´ç·š
                                const distText = distMeters > 1000 ? (distMeters/1000).toFixed(1) + ' km' : Math.round(distMeters) + ' m';
                                detail.distanceData = { text: distText + ' (ç›´ç·š)' };
                                resolve(detail);
                            }
                        } else {
                            resolve(detail);
                        }
                    } else {
                        resolve(null);
                    }
                });
            });
        }

        function getWalkingRoute(origin, destination) {
            return new Promise(resolve => {
                directionsService.route({
                    origin, destination, travelMode: 'WALKING'
                }, (result, status) => {
                    if (status === 'OK') {
                        const leg = result.routes[0].legs[0];
                        resolve({ text: `${leg.distance.text}ãƒ»${leg.duration.text}`, value: leg.duration.value });
                    } else resolve(null);
                });
            });
        }

        function createCard(p) {
            const card = document.createElement('div');
            card.className = "bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden flex flex-col card-enter hover:shadow-md transition-shadow duration-300";
            
            const photo = p.photos?.[0]?.getUrl({maxWidth: 400, maxHeight: 300}) || 'https://placehold.co/400x300/e2e8f0/94a3b8?text=No+Img';
            
            let statusHtml = '';
            if (p.opening_hours) {
                const isOpen = p.opening_hours.isOpen();
                const statusText = isOpen ? 'ç‡Ÿæ¥­ä¸­' : 'ä¼‘æ¯ä¸­';
                const statusColor = isOpen ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-50 text-rose-600';
                let hoursText = '';
                if (p.opening_hours.weekday_text) {
                    const dayIndex = (new Date().getDay() + 6) % 7;
                    hoursText = p.opening_hours.weekday_text[dayIndex] || '';
                    hoursText = hoursText.split(': ')[1] || hoursText;
                }
                statusHtml = `
                    <div class="flex flex-col items-end">
                        <span class="text-xs font-bold px-2 py-1 rounded-lg ${statusColor} mb-1">${statusText}</span>
                        ${hoursText ? `<span class="text-[10px] text-slate-500 bg-white/80 px-1.5 rounded backdrop-blur-sm">${hoursText}</span>` : ''}
                    </div>
                `;
            }

            const priceMap = ['','å¹³åƒ¹','ä¸­åƒ¹ä½','é«˜åƒ¹ä½','å¥¢è¯'];
            const priceText = priceMap[p.price_level] || '';

            const typeTranslations = {'cafe':'å’–å•¡å»³','restaurant':'é¤å»³','bar':'é…’å§','bakery':'éºµåŒ…åº—','meal_takeaway':'å¤–å¸¶'};
            let typeText = '';
            if(p.types) {
                for(let t of p.types) if(typeTranslations[t]) { typeText = typeTranslations[t]; break; }
            }
            
            let marketingHtml = '';
            if (p.rating > 4.8 && p.user_ratings_total > 1000) {
                 marketingHtml = `<div class="mt-2 text-[10px] text-orange-600 bg-orange-50 px-2 py-1 rounded border border-orange-100 flex items-center gap-1 w-fit">
                    <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                    å¯èƒ½ç‚ºè¡ŒéŠ·æ´»å‹•
                 </div>`;
            }

            card.innerHTML = `
                <a href="${p.url}" target="_blank" class="block relative aspect-video group">
                    <img src="${photo}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" loading="lazy">
                    <div class="absolute top-3 right-3 flex gap-2">
                        ${priceText ? `<span class="text-xs font-bold px-2 py-1 rounded-lg bg-white/90 text-slate-700 shadow-sm">${priceText}</span>` : ''}
                        ${statusHtml}
                    </div>
                </a>
                <div class="p-4 flex flex-col flex-grow">
                    <div class="flex justify-between items-start mb-1">
                        <div class="flex-grow min-w-0 mr-2">
                            ${typeText ? `<p class="text-xs text-indigo-600 font-bold mb-0.5">${typeText}</p>` : ''}
                            <h3 class="text-lg font-bold text-slate-900 leading-tight truncate">${p.name}</h3>
                        </div>
                        <div class="flex items-center gap-1 bg-yellow-50 px-1.5 py-1 rounded-lg flex-shrink-0 border border-yellow-100">
                            <span class="text-yellow-500 text-xs">â˜…</span>
                            <span class="text-slate-700 text-xs font-bold">${p.rating}</span>
                        </div>
                    </div>
                    <p class="text-xs text-slate-400 mb-1">(${p.user_ratings_total} å‰‡è©•è«–)</p>
                    ${marketingHtml}
                    
                    <div class="mt-auto pt-3 border-t border-slate-100 text-sm text-slate-500 space-y-1.5">
                        <div class="flex items-start gap-2">
                            <span class="flex-shrink-0 mt-0.5">ğŸ“</span>
                            <span class="line-clamp-1 text-xs">${p.formatted_address}</span>
                        </div>
                        ${p.distanceData ? `<div class="flex items-center gap-2 text-indigo-600 font-bold bg-indigo-50 px-2 py-1 rounded-lg w-fit text-xs">
                            <span>${currentSelections.mode === 'walking' ? 'ğŸš¶' : 'ğŸš—'}</span><span>${p.distanceData.text}</span>
                        </div>` : ''}
                        ${p.formatted_phone_number ? `<div class="flex items-center gap-2 text-xs">
                            <span>ğŸ“</span><a href="tel:${p.formatted_phone_number}" class="underline hover:text-indigo-600">${p.formatted_phone_number}</a>
                        </div>` : ''}
                    </div>
                </div>
            `;
            return card;
        }

        function showLoadingSkeleton() {
            resultsContainer.innerHTML = Array(6).fill('<div class="bg-white rounded-2xl h-72 animate-pulse bg-slate-200"></div>').join('');
        }

    </script>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB-Ev8iMdRHstXwwFL2L6JpghYzgGsbiqY&libraries=places,geometry&callback=initMap&language=zh-TW" async defer></script>
</body>
</html>
