<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ç¾é£Ÿæ¢éšªå®¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5; /* Indigo 600 */
            --primary-color-hover: #4338ca; /* Indigo 700 */
        }
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6; /* Gray 100 */
        }
        .loader {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        .small-loader {
            width: 24px;
            height: 24px;
            border-width: 3px;
        }
        /* å¡ç‰‡è¼‰å…¥å‹•ç•« */
        @keyframes card-fade-in {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .card-animation {
            animation: card-fade-in 0.5s ease-out forwards;
            opacity: 0; /* åˆå§‹ç‹€æ…‹ç‚ºé€æ˜ï¼Œç”±å‹•ç•«æ”¹è®Š */
        }
    </style>
</head>
<body class="text-gray-800 min-h-screen flex flex-col items-center p-4 sm:p-8">

    <div class="w-full max-w-5xl mx-auto">
        
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-500 to-indigo-600">
                ç¾é£Ÿæ¢éšªå®¶
            </h1>
            <p class="text-gray-500 mt-2">ç‚ºæ‚¨å³æ™‚æœå°‹é™„è¿‘çš„é«˜åˆ†å¥½è©•åº—å®¶ï¼</p>
        </header>

        <div id="search-form-container" class="bg-white p-6 rounded-2xl shadow-lg mb-12 transition-opacity duration-300">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                <div>
                    <label for="area-select" class="block text-sm font-medium text-gray-700 mb-2">åœ°å€</label>
                    <select id="area-select" class="w-full bg-gray-100 border-gray-300 border rounded-lg py-3 px-4 text-gray-800 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        <option value="current_location" selected>ğŸ“ ç›®å‰ä½ç½®é™„è¿‘ (æ­¥è¡Œ10åˆ†é˜)</option>
                        <option value="custom_area_input">âœï¸ è‡ªè¡Œè¼¸å…¥åœ°å€...</option>
                        <option value="å°åŒ—å¸‚ä¿¡ç¾©å€">å°åŒ—å¸‚ ä¿¡ç¾©å€</option>
                        <option value="å°åŒ—å¸‚å¤§å®‰å€">å°åŒ—å¸‚ å¤§å®‰å€</option>
                        <option value="å°åŒ—å¸‚ä¸­å±±å€">å°åŒ—å¸‚ ä¸­å±±å€</option>
                        <option value="å°åŒ—å¸‚æ¾å±±å€">å°åŒ—å¸‚ æ¾å±±å€</option>
                        <option value="å°åŒ—å¸‚ä¸­æ­£å€">å°åŒ—å¸‚ ä¸­æ­£å€</option>
                        <option value="å°åŒ—å¸‚è¬è¯å€">å°åŒ—å¸‚ è¬è¯å€</option>
                        <option value="å°åŒ—å¸‚å…§æ¹–å€">å°åŒ—å¸‚ å…§æ¹–å€</option>
                        <option value="å°åŒ—å¸‚å£«æ—å€">å°åŒ—å¸‚ å£«æ—å€</option>
                        <option value="å°åŒ—å¸‚å¤§åŒå€">å°åŒ—å¸‚ å¤§åŒå€</option>
                        <option value="å°åŒ—å¸‚æ–‡å±±å€">å°åŒ—å¸‚ æ–‡å±±å€</option>
                        <option value="æ–°åŒ—å¸‚æ¿æ©‹å€">æ–°åŒ—å¸‚ æ¿æ©‹å€</option>
                        <option value="æ–°åŒ—å¸‚ä¸­å’Œå€">æ–°åŒ—å¸‚ ä¸­å’Œå€</option>
                        <option value="æ–°åŒ—å¸‚æ°¸å’Œå€">æ–°åŒ—å¸‚ æ°¸å’Œå€</option>
                        <option value="æ–°åŒ—å¸‚æ–°èŠå€">æ–°åŒ—å¸‚ æ–°èŠå€</option>
                        <option value="æ–°åŒ—å¸‚æ–°åº—å€">æ–°åŒ—å¸‚ æ–°åº—å€</option>
                        <option value="æ–°åŒ—å¸‚ä¸‰é‡å€">æ–°åŒ—å¸‚ ä¸‰é‡å€</option>
                    </select>
                    <div id="custom-area-container" class="hidden mt-2">
                        <input type="text" id="custom-area-input" placeholder="ä¾‹å¦‚ï¼šå°åŒ—å¸‚ä¿¡ç¾©å€ã€æ—¥æœ¬æ±äº¬" class="w-full bg-gray-100 border-gray-300 border rounded-lg py-3 px-4 text-gray-800 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                    </div>
                </div>
                <div>
                    <label for="cuisine-select" class="block text-sm font-medium text-gray-700 mb-2">ç¾é£Ÿç¨®é¡</label>
                    <select id="cuisine-select" class="w-full bg-gray-100 border-gray-300 border rounded-lg py-3 px-4 text-gray-800 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        <option value="">æ‰€æœ‰ç¾é£Ÿ</option>
                        <option value="ç‰›è‚‰éºµ">ç‰›è‚‰éºµ</option>
                        <option value="ç«é‹">ç«é‹</option>
                        <option value="æ—¥å¼æ–™ç†">æ—¥å¼æ–™ç†</option>
                        <option value="éŸ“å¼æ–™ç†">éŸ“å¼æ–™ç†</option>
                        <option value="ç¾©å¤§åˆ©éºµ">ç¾©å¤§åˆ©éºµ</option>
                        <option value="ç¾å¼æ¼¢å ¡">ç¾å¼æ¼¢å ¡</option>
                        <option value="æ³°å¼æ–™ç†">æ³°å¼æ–™ç†</option>
                        <option value="å’–å•¡å»³">å’–å•¡å»³</option>
                        <option value="æ—©åˆé¤">æ—©åˆé¤</option>
                        <option value="å°åƒ">å°åƒ</option>
                        <option value="ç”œé»">ç”œé»</option>
                        <option value="éºµåŒ…åº—">éºµåŒ…åº—</option>
                        <option value="ç´ é£Ÿ">ç´ é£Ÿ</option>
                        <option value="custom_cuisine_input">âœï¸ è‡ªè¡Œè¼¸å…¥...</option>
                    </select>
                    <div id="custom-cuisine-container" class="hidden mt-2">
                        <input type="text" id="custom-cuisine-input" placeholder="ä¾‹å¦‚ï¼šæ‹‰éºµã€èˆ’èŠ™è•¾ã€æˆ–ä»»ä½•æƒ³åƒçš„ï¼" class="w-full bg-gray-100 border-gray-300 border rounded-lg py-3 px-4 text-gray-800 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                    </div>
                </div>
            </div>
            <div class="mt-6 flex items-center justify-center">
                <input id="open-now-checkbox" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                <label for="open-now-checkbox" class="ml-2 block text-sm text-gray-700 select-none">åƒ…é¡¯ç¤ºç›®å‰ç‡Ÿæ¥­ä¸­åº—å®¶</label>
            </div>
             <button id="search-button" class="mt-6 w-full text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all flex items-center justify-center" style="background-color: var(--primary-color);" disabled>
                <span id="button-text">ç­‰å¾…åœ°åœ–æœå‹™...</span>
                <div id="button-loader" class="loader hidden"></div>
            </button>
        </div>

        <main id="results-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8">
        </main>
        
        <div id="pagination-container" class="w-full flex justify-center mt-8"></div>

    </div>

    <script>
        const searchButton = document.getElementById('search-button');
        const searchFormContainer = document.getElementById('search-form-container');
        const areaSelect = document.getElementById('area-select');
        const cuisineSelect = document.getElementById('cuisine-select');
        const customAreaContainer = document.getElementById('custom-area-container');
        const customAreaInput = document.getElementById('custom-area-input');
        const customCuisineContainer = document.getElementById('custom-cuisine-container');
        const customCuisineInput = document.getElementById('custom-cuisine-input');
        const openNowCheckbox = document.getElementById('open-now-checkbox'); 
        const resultsContainer = document.getElementById('results-container');
        const buttonText = document.getElementById('button-text');
        const buttonLoader = document.getElementById('button-loader');
        const paginationContainer = document.getElementById('pagination-container');

        let placesService;
        let directionsService;
        let geocoder;
        let map; 
        let currentPagination = null;
        let allFetchedPlaces = []; 

        function initMap() {
            map = new google.maps.Map(document.createElement('div'));
            placesService = new google.maps.places.PlacesService(map);
            directionsService = new google.maps.DirectionsService();
            geocoder = new google.maps.Geocoder();
            console.log('Google Maps Services å·²æº–å‚™å°±ç·’ï¼');

            searchButton.disabled = false;
            searchButton.classList.remove('opacity-50', 'cursor-not-allowed');
            searchButton.style.backgroundColor = 'var(--primary-color)';
            searchButton.onmouseover = () => searchButton.style.backgroundColor = 'var(--primary-color-hover)';
            searchButton.onmouseout = () => searchButton.style.backgroundColor = 'var(--primary-color)';
            buttonText.textContent = 'é–‹å§‹æœå°‹';
        }

        window.setTimeout(() => {
            if (!placesService) {
                console.error("Google Maps Service failed to load.");
                buttonText.textContent = 'åœ°åœ–æœå‹™è¼‰å…¥å¤±æ•—';
                searchButton.disabled = true;
                searchButton.style.backgroundColor = '#ef4444'; 
                searchButton.classList.add('cursor-not-allowed');
            }
        }, 5000);

        function getUserLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†ä½ç½®åŠŸèƒ½ã€‚"));
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        });
                    },
                    () => {
                        reject(new Error("ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®ã€‚è«‹ç¢ºèªæ‚¨å·²æˆæ¬Šç€è¦½å™¨è®€å–ä½ç½®è³‡è¨Šã€‚"));
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            });
        }

        searchButton.addEventListener('click', (event) => {
            event.preventDefault();
            searchRestaurants(true); 
        });
        
        areaSelect.addEventListener('change', () => {
            if (areaSelect.value === 'custom_area_input') {
                customAreaContainer.classList.remove('hidden');
                customAreaInput.focus();
            } else {
                customAreaContainer.classList.add('hidden');
            }
        });

        cuisineSelect.addEventListener('change', () => {
            if (cuisineSelect.value === 'custom_cuisine_input') {
                customCuisineContainer.classList.remove('hidden');
                customCuisineInput.focus();
            } else {
                customCuisineContainer.classList.add('hidden');
            }
        });

        async function searchRestaurants(isInitialSearch = false) {
             if (isInitialSearch) {
                resultsContainer.innerHTML = ''; 
                paginationContainer.innerHTML = ''; 
                currentPagination = null;
                allFetchedPlaces = []; 
             }

            let area = areaSelect.value;
            if (area === 'custom_area_input') {
                area = customAreaInput.value.trim();
                if (area === '') {
                    resultsContainer.innerHTML = `<p class="text-red-500 col-span-full text-center">è«‹è¼¸å…¥è¦æœå°‹çš„åœ°å€ã€‚</p>`;
                    return;
                }
            }

            let cuisine = cuisineSelect.value;
            if (cuisine === 'custom_cuisine_input') {
                cuisine = customCuisineInput.value.trim();
            }

            const onlyOpen = openNowCheckbox.checked;

            if (!placesService) {
                resultsContainer.innerHTML = `<p class="text-red-500 col-span-full text-center">Google Maps æœå‹™å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>`;
                return;
            }

            showLoading(true);
            if (isInitialSearch) {
                resultsContainer.innerHTML = `<div class="col-span-full text-center text-gray-500">æ­£åœ¨åŠªåŠ›æœå°‹ä¸­ï¼Œè«‹ç¨å€™...</div>`; 
            }

            const searchQuery = cuisine === "" ? "é¤å»³" : cuisine;

            if (areaSelect.value === 'current_location') {
                try {
                    if (isInitialSearch) {
                       resultsContainer.innerHTML = `<div class="col-span-full text-center text-gray-500">æ­£åœ¨å–å¾—æ‚¨çš„ç›®å‰ä½ç½®...</div>`; 
                    }
                    const location = await getUserLocation();
                    await searchNearby(location, searchQuery, onlyOpen);
                } catch (error) {
                    resultsContainer.innerHTML = `<p class="text-red-500 col-span-full text-center">${error.message}</p>`;
                    showLoading(false);
                }
            } else {
                let userLocation = null;
                try {
                    userLocation = await getUserLocation();
                } catch (error) {
                    console.warn("ç„¡æ³•å–å¾—ä½¿ç”¨è€…ä½ç½®ä»¥è¨ˆç®—è·é›¢:", error.message);
                }
                await searchText(area, searchQuery, onlyOpen, userLocation);
            }
        }
        
        const processAndDisplayResults = async (results, status, pagination) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                currentPagination = pagination;

                let highRatedResults = results.filter(place => place.rating >= 4.0 && place.photos && place.place_id);
                
                const detailPromises = highRatedResults.map(place => processPlace(place, openNowCheckbox.checked));
                const newPlaces = (await Promise.all(detailPromises)).filter(data => data !== null);

                allFetchedPlaces = allFetchedPlaces.concat(newPlaces);
                
                sortAndDisplay(allFetchedPlaces); 
                
                handlePagination(); 

            } else if (status !== google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
                if (allFetchedPlaces.length === 0) {
                    resultsContainer.innerHTML = `<p class="text-red-500 col-span-full text-center">æœå°‹æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚éŒ¯èª¤: ${status}</p>`;
                }
            }
             
            if (!currentPagination || !currentPagination.hasNextPage) {
                paginationContainer.innerHTML = '';
            }
            
            showLoading(false);
        };
        
        async function searchNearby(location, keyword, onlyOpen) {
            const userLatLng = new google.maps.LatLng(location.lat, location.lng);
            const request = { location: userLatLng, rankBy: google.maps.places.RankBy.DISTANCE, keyword: keyword };
            if (onlyOpen) request.openNow = true;
            placesService.nearbySearch(request, processAndDisplayResults);
        }
        
        async function searchText(area, searchQuery, onlyOpen, userLocation) {
            try {
                const geoResult = await geocodeAddress(area);
                const request = { location: geoResult.location, radius: 50000, query: `${area} ${searchQuery}` };
                if (onlyOpen) request.openNow = true;
                placesService.textSearch(request, processAndDisplayResults);
            } catch(error) {
                resultsContainer.innerHTML = `<p class="text-red-500 col-span-full text-center">${error.message}</p>`;
                showLoading(false);
            }
        }
        
        function handlePagination() {
            paginationContainer.innerHTML = ''; 
            if (currentPagination && currentPagination.hasNextPage) {
                const loadMoreButton = document.createElement('button');
                loadMoreButton.innerHTML = `<span id="more-btn-text">è¼‰å…¥æ›´å¤šçµæœ</span><div id="more-btn-loader" class="loader small-loader hidden"></div>`;
                loadMoreButton.className = "text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all flex items-center justify-center gap-2";
                loadMoreButton.style.backgroundColor = 'var(--primary-color)';
                loadMoreButton.onmouseover = () => loadMoreButton.style.backgroundColor = 'var(--primary-color-hover)';
                loadMoreButton.onmouseout = () => loadMoreButton.style.backgroundColor = 'var(--primary-color)';
                
                loadMoreButton.addEventListener('click', () => {
                    loadMoreButton.querySelector('#more-btn-text').classList.add('hidden');
                    loadMoreButton.querySelector('#more-btn-loader').classList.remove('hidden');
                    loadMoreButton.disabled = true;
                    currentPagination.nextPage();
                });
                paginationContainer.appendChild(loadMoreButton);
            }
        }
        
        function geocodeAddress(address) {
            return new Promise((resolve, reject) => {
                geocoder.geocode({ 'address': address }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        resolve({ location: results[0].geometry.location });
                    } else {
                        reject(new Error(`ç„¡æ³•æ‰¾åˆ°æ‚¨è¼¸å…¥çš„åœ°å€ï¼šã€Œ${address}ã€ã€‚`));
                    }
                });
            });
        }
        
        function getWalkingDistance(origin, destination) {
             return new Promise((resolve) => {
                const request = { origin, destination, travelMode: 'WALKING' };
                directionsService.route(request, (result, status) => {
                    if (status == 'OK' && result.routes[0].legs[0]) {
                        const leg = result.routes[0].legs[0];
                        resolve({ distanceText: leg.distance.text, durationText: leg.duration.text, durationValue: leg.duration.value });
                    } else { resolve(null); }
                });
            });
        }

        async function processPlace(place, onlyOpen) {
            try {
                const detailedPlace = await getPlaceDetails(place.place_id);
                if (onlyOpen && detailedPlace.opening_hours?.isOpen() !== true) return null;
                return { ...detailedPlace, distanceData: place.distanceData }; 
            } catch (error) {
                console.error(`è™•ç†åœ°é» ${place.name} æ™‚ç™¼ç”ŸéŒ¯èª¤:`, error);
                return null; 
            }
        }

        function getPlaceDetails(placeId) {
            return new Promise((resolve, reject) => {
                const request = {
                    placeId,
                    fields: ['name', 'rating', 'user_ratings_total', 'formatted_address', 'photos', 'place_id', 'opening_hours', 'url', 'price_level', 'types', 'formatted_phone_number']
                };
                placesService.getDetails(request, (place, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK && place) {
                        resolve(place);
                    } else { reject(new Error(`ç„¡æ³•ç²å–åœ°é»è©³ç´°è³‡è¨Š: ${status}`)); }
                });
            });
        }
        
        function sortAndDisplay(results) {
            resultsContainer.innerHTML = '';
            results.sort((a, b) => (b.user_ratings_total || 0) - (a.user_ratings_total || 0) || (b.rating || 0) - (a.rating || 0));

            if (results.length > 0) {
                results.forEach((data, index) => {
                    const card = createRestaurantCard(data, index);
                    resultsContainer.appendChild(card);
                });
            } else {
                 resultsContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center">æ‰¾ä¸åˆ°ç¬¦åˆæ‰€æœ‰æ¢ä»¶çš„é¤å»³ã€‚</p>`;
            }
        }

        const typeTranslations = {
            'cafe': 'å’–å•¡å»³', 'restaurant': 'é¤å»³', 'bar': 'é…’å§', 'meal_delivery': 'å¤–é€',
            'meal_takeaway': 'å¤–å¸¶', 'bakery': 'éºµåŒ…åº—', 'sushi_restaurant': 'å£½å¸åº—',
            'ramen_restaurant': 'æ‹‰éºµåº—', 'italian_restaurant': 'ç¾©å¼é¤å»³', 'american_restaurant': 'ç¾å¼é¤å»³',
            'chinese_restaurant': 'ä¸­å¼é¤å»³', 'japanese_restaurant': 'æ—¥å¼æ–™ç†', 'korean_restaurant': 'éŸ“å¼æ–™ç†',
            'thai_restaurant': 'æ³°å¼æ–™ç†', 'indian_restaurant': 'å°åº¦æ–™ç†', 'vietnamese_restaurant': 'è¶Šå—æ–™ç†',
            'french_restaurant': 'æ³•å¼é¤å»³', 'spanish_restaurant': 'è¥¿ç­ç‰™é¤å»³', 'mexican_restaurant': 'å¢¨è¥¿å“¥é¤å»³',
            'vegetarian_restaurant': 'ç´ é£Ÿé¤å»³', 'fast_food_restaurant': 'é€Ÿé£Ÿåº—', 'seafood_restaurant': 'æµ·é®®é¤å»³',
            'steak_house': 'ç‰›æ’é¤¨', 'pizza_place': 'æŠ«è–©åº—', 'brunch_restaurant': 'æ—©åˆé¤'
        };

        function getPrimaryType(types) {
            if (!types) return '';
            for (const type of types) {
                if (typeTranslations[type]) {
                    return typeTranslations[type];
                }
            }
            return '';
        }

        function createRestaurantCard(place, index) {
            const card = document.createElement('div');
            card.className = "bg-white rounded-2xl shadow-lg overflow-hidden flex flex-col card-animation";
            card.style.animationDelay = `${index * 80}ms`;

            const photoUrl = place.photos?.[0]?.getUrl({ maxWidth: 400, maxHeight: 300 }) ?? 'https://placehold.co/400x300/e2e8f0/94a3b8?text=æš«ç„¡åœ–ç‰‡';
            const ratingStars = 'â˜…'.repeat(Math.round(place.rating)) + 'â˜†'.repeat(5 - Math.round(place.rating));
            const mapsUrl = place.url || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name)}&query_place_id=${place.place_id}`;
            
            let statusTag = '';
            if (place.opening_hours?.isOpen() !== undefined) {
                const isOpen = place.opening_hours.isOpen();
                const statusClass = isOpen ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                statusTag = `<span class="text-xs font-medium px-2.5 py-1 rounded-full ${statusClass}">${isOpen ? 'ç‡Ÿæ¥­ä¸­' : 'ä¼‘æ¯ä¸­'}</span>`;
            }
            
            let priceTag = '';
            if (place.price_level !== undefined && place.price_level !== null) {
                let priceText = '';
                switch (place.price_level) {
                    case 1: priceText = 'å¹³åƒ¹'; break;
                    case 2: priceText = 'ä¸­ç­‰åƒ¹ä½'; break;
                    case 3: priceText = 'é«˜åƒ¹ä½'; break;
                    case 4: priceText = 'å¥¢è¯é¥—å®´'; break;
                }
                if (priceText) {
                    priceTag = `<span class="text-xs font-medium px-2.5 py-1 rounded-full bg-indigo-100 text-indigo-800">${priceText}</span>`;
                }
            }

            const primaryType = getPrimaryType(place.types);
            const typeTag = primaryType ? `<p class="text-sm font-semibold text-indigo-600">${primaryType}</p>` : '';

            let hoursInfo = '';
            if (place.opening_hours?.weekday_text?.length > 0) {
                 const googleDayIndex = (new Date().getDay() + 6) % 7; 
                 const todayHoursText = place.opening_hours.weekday_text[googleDayIndex];
                 hoursInfo = `
                 <div class="flex items-center text-gray-500">
                    <svg class="w-4 h-4 mr-2 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M16.2,16.2L11,13V7H12.5V12.2L17,14.9L16.2,16.2Z" /></svg>
                    <span>${todayHoursText}</span>
                 </div>
                 `;
            }

            let phoneInfo = '';
            if (place.formatted_phone_number) {
                phoneInfo = `
                <div class="flex items-center text-gray-500">
                    <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,15.18C15.69,14.9 16.08,14.82 16.43,14.93C17.55,15.3 18.75,15.5 20,15.5A1,1 0 0,1 21,16.5V20A1,1 0 0,1 20,21A17,17 0 0,1 3,4A1,1 0 0,1 4,3H7.5A1,1 0 0,1 8.5,4C8.5,5.25 8.7,6.45 9.07,7.57C9.18,7.92 9.1,8.31 8.82,8.59L6.62,10.79Z" /></svg>
                    <a href="tel:${place.formatted_phone_number}" class="hover:text-indigo-600 transition-colors">${place.formatted_phone_number}</a>
                </div>
                `;
            }
            
            let distanceInfo = '';
            if (place.distanceData) {
                const displayText = place.distanceData.durationText ? `${place.distanceData.distanceText}ãƒ»ç´„ ${place.distanceData.durationText}` : place.distanceData.distanceText;
                distanceInfo = `<div class="flex items-center text-gray-500">
                     <svg class="w-4 h-4 mr-2 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M14.5,4A1.5,1.5 0 0,0 13,5.5A1.5,1.5 0 0,0 14.5,7A1.5,1.5 0 0,0 16,5.5A1.5,1.5 0 0,0 14.5,4M11.5,9L9,14.5V22H11V16H12V13.5L14.5,12L15.6,12.5L11.5,9Z" />
                     </svg>
                    <span>${displayText}</span>
                </div>`;
            }

            card.innerHTML = `
                <div class="relative">
                    <a href="${mapsUrl}" target="_blank" rel="noopener noreferrer" class="block">
                        <img src="${photoUrl}" alt="${place.name}" class="w-full h-48 object-cover">
                    </a>
                    <div class="absolute top-3 right-3 flex flex-wrap gap-2 justify-end">
                       ${statusTag} ${priceTag}
                    </div>
                </div>
                <div class="p-5 flex flex-col flex-grow">
                    ${typeTag}
                    <h2 class="text-lg font-bold mt-1 mb-1 text-gray-900 leading-tight">${place.name}</h2>
                    <div class="flex items-center mb-4 text-sm">
                        <span class="text-yellow-500 mr-1.5">${ratingStars}</span>
                        <span class="text-gray-600 font-semibold">${place.rating}</span>
                        <span class="text-gray-400 ml-1">(${place.user_ratings_total || 0}å‰‡)</span>
                    </div>
                     <div class="text-sm space-y-2.5 mt-auto pt-4 border-t border-gray-100">
                         <div class="flex items-center text-gray-500">
                             <svg class="w-4 h-4 mr-2 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12,11.5A2.5,2.5 0 0,1 9.5,9A2.5,2.5 0 0,1 12,6.5A2.5,2.5 0 0,1 14.5,9A2.5,2.5 0 0,1 12,11.5M12,2A7,7 0 0,0 5,9C5,14.25 12,22 12,22C12,22 19,14.25 19,9A7,7 0 0,0 12,2Z" /></svg>
                             <span class="leading-tight">${place.formatted_address || 'æœªæä¾›åœ°å€'}</span>
                         </div>
                         ${hoursInfo}
                         ${phoneInfo}
                         ${distanceInfo}
                     </div>
                </div>
            `;
            return card;
        }

        function showLoading(isLoading) {
            searchFormContainer.classList.toggle('opacity-50', isLoading);
            searchFormContainer.classList.toggle('pointer-events-none', isLoading);
            buttonText.classList.toggle('hidden', isLoading);
            buttonLoader.classList.toggle('hidden', !isLoading);
            searchButton.disabled = isLoading;
        }

    </script>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB-Ev8iMdRHstXwwFL2L6JpghYzgGsbiqY&libraries=places,geometry&callback=initMap&language=zh-TW" async defer></script>

</body>
</html>
